<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>9449 Kiosk</title>
    <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.js"></script>
    <style>
        :root { --glass: rgba(255, 255, 255, 0.1); --accent: #00D2FF; --success: #00FF85; }
        body { font-family: sans-serif; margin: 0; background: #0d1117; color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        
        /* User Grid */
        .user-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 20px; overflow-y: auto; flex-grow: 1; }
        .user-card { background: var(--glass); border-radius: 20px; padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .avatar { width: 60px; height: 60px; border-radius: 50%; background: #333; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .status-dot { position: absolute; top: 15px; right: 15px; width: 10px; height: 10px; border-radius: 50%; }
        .online { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .offline { background: #555; }

        /* Scanner Overlay */
        #scanner-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        video { width: 320px; height: 400px; object-fit: cover; border-radius: 30px; border: 2px solid var(--accent); }
        .log-box { width: 320px; height: 80px; background: #000; font-family: monospace; font-size: 10px; color: var(--success); padding: 10px; margin: 15px 0; overflow-y: auto; border-radius: 10px; }

        /* Modals */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 200; align-items: center; justify-content: center; }
        .modal-content { background: #1c2128; padding: 30px; border-radius: 25px; width: 300px; text-align: center; border: 1px solid #444; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        button { padding: 12px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-primary { background: white; color: black; }
        .btn-cancel { background: #333; color: white; }
    </style>
</head>
<body>

<header>
    <div>
        <h1 id="time" style="margin:0">00:00</h1>
        <div id="aiStatus" style="font-size: 0.7rem; color: #777;">AI INITIALIZING...</div>
    </div>
    <button id="loginBtn" onclick="openScanner()" disabled style="background:var(--accent); color:black; border-radius:50px; padding:10px 20px; font-weight:800;">FACE LOGIN</button>
</header>

<div class="user-grid" id="userGrid"></div>

<div id="scanner-overlay">
    <h2>Align Face</h2>
    <video id="faceVideo" playsinline autoplay muted></video>
    <div class="log-box" id="log">> Camera standby...</div>
    <button id="scanBtn" onclick="runCapture()" style="width:320px; background:var(--accent); height:50px;">CAPTURE SCAN</button>
    <button onclick="closeScanner()" style="background:none; color:white; margin-top:10px; opacity:0.5;">Close</button>
</div>

<div id="actionModal" class="modal">
    <div class="modal-content">
        <div id="mAvatar" class="avatar" style="width:80px; height:80px"></div>
        <h2 id="mName" style="margin:10px 0">User Name</h2>
        <div class="btn-row" id="mActions"></div>
        <button onclick="closeModal()" class="btn-cancel" style="width:100%; margin-top:10px;">Close</button>
    </div>
</div>

<script>
    let allUsers = [];
    let faceStream = null;

    async function init() {
        // 1. Fetch Users
        const res = await fetch('/api/users/all');
        allUsers = await res.json();
        renderGrid(allUsers);

        // 2. Pre-Load AI (Memory Persistent)
        try {
            await faceapi.nets.tinyFaceDetector.loadFromUri('/models');
            await faceapi.nets.faceLandmark68TinyNet.loadFromUri('/models');
            await faceapi.nets.faceRecognitionNet.loadFromUri('/models');
            document.getElementById('aiStatus').innerText = "AI ONLINE";
            document.getElementById('loginBtn').disabled = false;
        } catch(e) { document.getElementById('aiStatus').innerText = "AI OFFLINE"; }
        
        setInterval(() => { document.getElementById('time').innerText = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }, 1000);
    }

    function renderGrid(users) {
        document.getElementById('userGrid').innerHTML = users.map(u => `
            <div class="user-card" onclick='handleSelect(${JSON.stringify(u)})'>
                <div class="status-dot ${u.status === 'checked_in' ? 'online' : 'offline'}"></div>
                <div class="avatar">${u.profile_picture_url ? `<img src="${u.profile_picture_url}">` : u.name[0]}</div>
                <div style="font-size:0.85rem; font-weight:600;">${u.name}</div>
            </div>
        `).join('');
    }

    async function openScanner() {
        document.getElementById('scanner-overlay').style.display = 'flex';
        faceStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        document.getElementById('faceVideo').srcObject = faceStream;
    }

    async function runCapture() {
        const btn = document.getElementById('scanBtn');
        btn.disabled = true;
        const log = (m) => document.getElementById('log').innerHTML += `<div>> ${m}</div>`;
        
        log("Analyzing...");
        const detection = await faceapi.detectSingleFace(document.getElementById('faceVideo'), new faceapi.TinyFaceDetectorOptions({ inputSize: 224 })).withFaceLandmarks(true).withFaceDescriptor();

        if (!detection) {
            log("No face found.");
            btn.disabled = false;
            return;
        }

        // BIOMETRIC MATCHING (Bulletproofed)
        const labeled = allUsers
            .filter(u => u.face_descriptor && u.face_descriptor !== "null")
            .map(u => {
                try {
                    const raw = JSON.parse(u.face_descriptor);
                    const listOfArrays = Array.isArray(raw) ? raw : [raw];
                    const valid = listOfArrays.map(item => new Float32Array(Object.values(item))).filter(d => d.length === 128);
                    return valid.length > 0 ? new faceapi.LabeledFaceDescriptors(u.id.toString(), valid) : null;
                } catch(e) { return null; }
            }).filter(v => v !== null);

        if (labeled.length === 0) { log("No profiles loaded."); btn.disabled = false; return; }

        const match = new faceapi.FaceMatcher(labeled, 0.6).findBestMatch(detection.descriptor);
        if (match.label !== 'unknown') {
            const user = allUsers.find(u => u.id == match.label);
            closeScanner();
            handleSelect(user);
        } else {
            log("Unknown User.");
            btn.disabled = false;
        }
    }

    function handleSelect(user) {
        document.getElementById('mName').innerText = user.name;
        document.getElementById('mAvatar').innerHTML = user.profile_picture_url ? `<img src="${user.profile_picture_url}">` : user.name[0];
        const acts = document.getElementById('mActions');
        acts.innerHTML = user.status === 'checked_out' 
            ? `<button class="btn-primary" style="grid-column:span 2" onclick="perform('check-in', ${user.id})">CHECK IN</button>`
            : `<button class="btn-primary" onclick="perform('check-out', ${user.id})">OUT</button><button class="btn-primary" onclick="perform('break-start', ${user.id})">BREAK</button>`;
        document.getElementById('actionModal').style.display = 'flex';
    }

    async function perform(action, userId) {
        const url = action === 'check-in' ? '/api/check-in' : action === 'check-out' ? '/api/check-out' : '/api/break/start';
        await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ user_id: userId }) });
        location.reload();
    }

    function closeScanner() { if(faceStream) faceStream.getTracks().forEach(t => t.stop()); document.getElementById('scanner-overlay').style.display = 'none'; }
    function closeModal() { document.getElementById('actionModal').style.display = 'none'; }
    window.onload = init;
</script>
</body>
</html>